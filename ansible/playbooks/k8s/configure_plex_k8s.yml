---
# Inventory file is in /etc/ansible/hosts
# run command ansible-playbook {filename} -u {username} -K
- name: Configure Plex
  hosts: localhost
  vars_files:
    - /users/kevin/.ansible_secrets.yml
  vars:
    deployment_name: plex
    image_name: plexinc/pms-docker
    image_tag: 1.41.3.9292-bc7397402
    namespace_name: plex
    env_map:
      - name: PLEX_CLAIM 
        value: "{{ plex_claim }}"
      - name: TZ
        value: America/New_York

    ports:
      - container_port: 32400
        name: plex
    service_name: plex-service
    service_selector: plex
    service_type: NodePort
    service_ports:
      - name: plex
        nodePort: 32400
        port: 32400
        target_port: 32400
    volumes:
      - path: /etc/plex/config
        name: config
      - path: /mnt/plex/temp
        name: transcode
      - path: /mnt/plex/media
        name: data
    volume_mounts:
      - path: /config
        name: config
      - path: /transcode
        name: transcode
      - path: /data
        name: data

  tasks:
    - name: Render namespace manifest
      template:
        src: ../../../templates/k8s/namespace.yaml.j2
        dest: /tmp/{{ namespace_name }}.yaml
        lstrip_blocks: true
        trim_blocks: true

    - name: Render Deployment manifest
      template:
        src: ../../../templates/k8s/deployment.yaml.j2
        dest: /tmp/{{ deployment_name }}-deployment.yaml
        lstrip_blocks: true
        trim_blocks: true

    - name: Render Service manifest
      template:
        src: ../../../templates/k8s/service.yaml.j2
        dest: /tmp/{{ service_name }}.yaml
        lstrip_blocks: true
        trim_blocks: true


    - name: Apply Kubernetes manifests
      k8s:
        state: present
        src: "{{ item }}"
      loop:
        - /tmp/{{ namespace_name }}.yaml
        - /tmp/{{ service_name }}.yaml
        - /tmp/{{ deployment_name }}-deployment.yaml
